/*! main 2016-06-13 */
function getMsgId(){return 65535==msgId?msgId=0:msgId++,msgId}function sendCMD(a,b){appSendMsgTpl.params.data.raw=UARTDATA2.encode(a,protocolTemplete,b,getMsgId()),console.log(appSendMsgTpl),Hekr.send(appSendMsgTpl,devTid,function(a,b){return $.hekrToast(!1),b?void console.log("error:"+JSON.stringify(b)):a.params.data.raw?void setState(a.params.data.raw):(console.error("colors error resp:",respData),void console.log("错误response"))})}function getUrlParam(a){var b=new RegExp("(^|&)"+a+"=([^&]*)(&|$)"),c=window.location.search.substr(1).match(b);return null!=c?unescape(c[2]):null}function gears(a){var b=$("#gears").data("oldValue");if(b!=a.value){switch($.hekrToast(!0,"消息正在发送中...",6e3,!0),a.value){case 1:sendCMD({AirFlow:1},3);break;case 2:sendCMD({AirFlow:2},3)}$("#gears").data("timeout",setTimeout(function(){$("#gears").data("hekrSlotSelector").update({value:b}),$.hekrToast("响应超时~请稍后重试")},5e3))}}function range(a,b){var c=$(a).data("oldValue");c!=b.value&&($.hekrToast(!0,"消息正在发送中...",6e3,!0),sendCMD({HumiditySetting:b.value},5),$(a).data("timeout",setTimeout(function(){$(a).data("hekrRangeSlider").update({value:c}),$.hekrToast("响应超时~请稍后重试")},5e3)))}function power(){var a=$(this);$.hekrToast(!0,"消息正在发送中...",6e3,!0),a.hasClass("hekr-btn-on")?sendCMD({Power:0},2):sendCMD({Power:1},2),a.data("timeout",setTimeout(function(){$.hekrToast("响应超时~请稍后重试")},5e3))}function anion(){var a=$(this);$.hekrToast(!0,"消息正在发送中...",6e3,!0),a.hasClass("hekr-btn-on")?sendCMD({FilterWash:0},4):sendCMD({FilterWash:1},4),a.data("timeout",setTimeout(function(){$.hekrToast("响应超时~请稍后重试")},5e3))}function ON(){$("#gears i.hekr-btn-on").css("color","#f56735"),instanceGears.enable(),instanceRangeSlider1.enable(),instanceGears.update({slider:{init:!0,icon:'<i class="hekr-iconfont hekr-btn-on" style="font-size: .16rem;">&#xe852;</i> '},value:1}),instanceRangeSlider1.update({value:10})}function OFF(){$("#anion").off("touchend").removeClass("hekr-btn-on").addClass("hekr-btn-disabled"),instanceGears.update({slider:{init:!0,icon:'<i class="hekr-iconfont" style="font-size: .16rem;">&#xe852;</i> '},value:1}),instanceRangeSlider1.update({value:10}),instanceGears.disable(),instanceRangeSlider1.disable(),FCircle()}function setState(a){a=UARTDATA2.decode(a,protocolTemplete),console.log(a),1!==a.cmdId&&2!==a.cmdId||(clearTimeout($("#power").data("timeout")),1===a.Power?($("#power").addClass("hekr-btn-on"),$(".item-first .label span").removeClass("off"),$(".item-first .item-text").text("已开"),ON()):0===a.Power&&($("#power").removeClass("hekr-btn-on"),$(".item-first .label span").addClass("off"),$(".item-first .item-text").text("已关"),$(".present > div span,.control > div span").text("--"),Circle=[0,0],OFF())),1!==a.cmdId&&5!==a.cmdId||(clearTimeout($("#range1").data("timeout")),0==a.HumiditySetting||(a.HumiditySetting<=10?instanceRangeSlider1.update({value:10}):a.HumiditySetting>=95?instanceRangeSlider1.update({value:95}):instanceRangeSlider1.update({value:a.HumiditySetting}))),1!==a.cmdId&&4!==a.cmdId||(clearTimeout($("#anion").data("timeout")),1==a.FilterWash?($("#anion").addClass("hekr-btn-on"),$(".cleansing span").text("已启用")):0==a.FilterWash&&($("#anion").removeClass("hekr-btn-on"),$(".cleansing span").text("待机中"))),1!==a.cmdId&&3!==a.cmdId||(clearTimeout($("#gears").data("timeout")),1==a.AirFlow?instanceGears.update({value:1}):2==a.AirFlow&&instanceGears.update({value:2})),1===a.cmdId&&(a.CurrTemp<=0?($(".temperature span").text("0℃"),Circle[1]=0):a.CurrTemp>=70?($(".temperature span").text("70℃"),Circle[1]=70):($(".temperature span").text(a.CurrTemp+"℃"),Circle[1]=a.CurrTemp),a.CurrHum<=1?($(".humidity span").text("1%"),Circle[0]=1):a.CurrHum>=100?($(".humidity span").text("100%"),Circle[0]=100):($(".humidity span").text(a.CurrHum+"%"),Circle[0]=a.CurrHum),FCircle(),a.PanGTemp>10?$(".coiler span").text(-(10-a.PanGTemp)+"℃"):0==a.PanGTemp?$(".coiler span").text("0℃"):$(".coiler span").text(a.PanGTemp-10+"℃"),$(".strainer span").text(a.FilterUsedTime+"h"),a.FilterUsedTime>=2e3&&1==a.Power?$("#anion").off("touchend").on("touchend",anion).removeClass("hekr-btn-disabled"):$("#anion").off("touchend").removeClass("hekr-btn-on").addClass("hekr-btn-disabled"),1==a.HumidityError&&$(".humidity span").text("--"),1==a.TempOverPrompt&&$(".temperature span").text("--"),1==a.PanGError&&$(".coiler span").text("--"),warning("湿度传感器故障，请及时维修",a.HumidityError),warning("高压保护",a.OverVoltagePrompt),warning("盘管传感器故障，请及时维修",a.PanGError),warning("欠压保护",a.UnVoltagePrompt),warning("超温保护",a.TempOverPrompt),warning("水满保护",a.WaterOverPrompt))}function warning(a,b){var c,d,e=$("#warn .hekr-slide-scroller > .hekr-slide-item"),f=!0;if(e.length>0){for(var g=0;g<e.length;g++)if(d=$(e).eq(g).find("span"),$(d).text()==a){f=!1,0==b&&($(e).eq(g).remove(),instanceSlideWarn.refresh());break}f&&1==b&&($.hekrConfirm({message:a,messageColor:"white",buttonType:"single",confirmButton:"我知道了",confirmButtonColor:"blue",confirmButtonEvent:function(){console.log(this)},input:!1,context:jQuery}),c=html.replace("{text}",a),console.log(c),$("#warn .hekr-slide-scroller").append(c),instanceSlideWarn.refresh())}else 1==b&&(console.log(3),$.hekrConfirm({message:a,messageColor:"white",buttonType:"single",confirmButton:"我知道了",confirmButtonColor:"blue",confirmButtonEvent:function(){console.log(this)},input:!1,context:jQuery}),c=html.replace("{text}",a),$("#warn .hekr-slide-scroller").append(c),instanceSlideWarn.refresh())}function FCircle(){instanceCircle.update({circles:[{color:"#13b5b1",beginAngle:Math.PI/2,min:0,max:100,width:10,gutter:0,value:Circle[0]},{color:"#f29876",beginAngle:Math.PI/2,min:0,max:100,width:7,gutter:4,value:Circle[1]}]})}function getListTimer(){var a="https://user-openapi.hekr.me/rule/schedulerTask",b={devTid:devTid,ctrlKey:ctrlKey},c="GET";connect(c,a,b,"list")}function addTimer(a,b,c,d,e){var f="https://user-openapi.hekr.me/rule/schedulerTask",g="POST",h=JSON.stringify(dispose_dataSet(b));b.name.length>12?$.hekrConfirm({title:"标签长度为12个字符",titleColor:"red",messageColor:"red",buttonType:"single",confirmButton:"马上修改",confirmButtonColor:"white",confirmButtonEvent:function(){this.hide()},input:!1,context:$(".hekr-confirm")}):connect(g,f,h,"add")}function changeTimer(a,b,c,d,e){var f=timingData[a].taskId,g="https://user-openapi.hekr.me/rule/schedulerTask?taskId="+f+"&devTid="+devTid+"&ctrlKey="+ctrlKey,h=JSON.stringify(dispose_dataSet(b)),i="PUT";b.name.length>12?$.hekrConfirm({title:"标签长度为12个字符",titleColor:"red",messageColor:"red",buttonType:"single",confirmButton:"马上修改",confirmButtonColor:"white",confirmButtonEvent:function(){this.hide()},input:!1,context:$(".hekr-confirm")}):connect(i,g,h,"add")}function delTimer(a,b,c,d,e){var f=timingData[a].taskId,g="https://user-openapi.hekr.me/rule/schedulerTask?devTid="+devTid+"&ctrlKey="+ctrlKey+"&taskId="+f,h="DELETE",i={};connect(h,g,i,"del",c,a)}function switchTimer(a,b,c,d,e){var f=timingData[a].taskId,g=0==timingData[a].enable&&0==timingData[a].expired,h="https://user-openapi.hekr.me/rule/schedulerTask?taskId="+f+"&devTid="+devTid+"&ctrlKey="+ctrlKey,i=JSON.stringify({enable:g}),j="PUT";connect(j,h,i,"change",c,a)}function dispose_dataSet(a){var b={devTid:devTid,ctrlKey:ctrlKey,code:{raw:1},enable:!0,taskName:a.name,schedulerType:"GENERIC",taskKey:"taskKey_"+Math.random().toString(36).substr(2),timeZoneOffset:480,cronExpr:null},c=parseInt(a.main.values[0],10);1===c?b.code.raw=timerOn:2===c&&(b.code.raw=timerOff);var d={seconds:0,minutes:null,hours:null,daysOfMonth:null,months:null,daysOfWeek:null,years:null},e=a.time,f=parseInt(e[0],10),g=parseInt(e[1],10),h=a.repeats,i=new Date;if(h.values.length){d.daysOfMonth="?",d.months="*",d.years=i.getFullYear(),d.daysOfWeek="";for(var j=0;j<h.values.length;j++)switch(h.values[j]){case 7:d.daysOfWeek+="7,";break;case 1:d.daysOfWeek+="1,";break;case 2:d.daysOfWeek+="2,";break;case 3:d.daysOfWeek+="3,";break;case 4:d.daysOfWeek+="4,";break;case 5:d.daysOfWeek+="5,";break;case 6:d.daysOfWeek+="6,"}d.daysOfWeek=d.daysOfWeek.replace(/(^,*)|(,*$)/g,"")}else{var k=i.getHours(),l=i.getMinutes();if(d.daysOfWeek="?",!(f>k||f===k&&g>l))return void $.hekrToast("您选择的时间已经流逝了，请重新选择！");d.daysOfMonth=i.getDate(),d.months=i.getMonth()+1,d.years=i.getFullYear(),d.seconds=0}return d.hours=f,d.minutes=g,b.cronExpr=CronExpr.encode(d),b}function processing(a){if($.isArray(a)){timingData=seqencing(a);var b=analyzeTimingData(timingData),c={limit:10,limitMessage:"预约条数已达上限！",timingTitle:"预约总览",addTitle:"新增预约",editTitle:"预约编辑",emptyMessage:"暂无预约，请添加！",labelMessage:"未命名",beforeEditButtonText:"编辑",afterEditButtonsText:"完成",addButtonText:"添加",cancelButtonText:"取消",confirmButtonText:"确定",circleIcon:"&#xe702;",deleteIcon:"&#xe61f;",arrowIcon:"&#xe6e0;",chooseIcon:"&#xe671;",models:{label:{name:"标签"},time:{name:"时间"},main:{name:"开关",type:3,values:[1,2],maps:["开启","关闭"],required:!0},repeats:{type:2,name:"重复",values:[2,3,4,5,6,7,1],maps:["周一","周二","周三","周四","周五","周六","周日"],required:!1}},data:b,onCreate:addTimer,onDelete:delTimer,onUpdate:changeTimer,onSwitch:switchTimer};$timerID.data("hekrTiming",null),$timerID.hekrTiming(c),getLastTimer()}else $.hekrToast("操作出现错误，请稍后重试！")}function seqencing(a){for(var b=[],c=[],d=[],e=[],f=0;f<a.length;f++)null==a[f].nextTriggerTime&&1==a[f].expired?b.push(a[f]):null!=a[f].nextTriggerTime&&0==a[f].enable?c.push(a[f]):null!=a[f].nextTriggerTime&&1==a[f].enable&&d.push(a[f]);return d.sort(function(a,b){return a.nextTriggerTime-b.nextTriggerTime}),c.sort(function(a,b){return a.nextTriggerTime-b.nextTriggerTime}),e=d.concat(c,b)}function analyzeTimingData(a){for(var b=[],c=a.length,d=0;c>d;d++){var e,f=CronExpr.decode(a[d].cronExpr),g=a[d].code.raw;if(b[d]={},b[d].name=a[d].taskName,b[d].on=1==a[d].enable&&0==a[d].expired,b[d].time=[f.hours,f.minutes],b[d].main={},g.indexOf(timerOn)>-1?(b[d].main.values=[1],b[d].main.alias="开"):g.indexOf(timerOff)>-1&&(b[d].main.values=[2],b[d].main.alias="关"),b[d].repeats={},"?"!==f.daysOfWeek){e=f.daysOfWeek.split(","),b[d].repeats.alias="",b[d].repeats.values=[];var h=0,i=e.length;if(7==i)b[d].repeats.alias="每天",b[d].repeats.values=[2,3,4,5,6,7,1];else{for(;i>h;h++)switch(e[h].toUpperCase()){case"MON":case"2":b[d].repeats.alias+="周一 ",b[d].repeats.values.push(2);break;case"TUES":case"3":b[d].repeats.alias+="周二 ",b[d].repeats.values.push(3);break;case"WED":case"4":b[d].repeats.alias+="周三 ",b[d].repeats.values.push(4);break;case"THUR":case"5":b[d].repeats.alias+="周四 ",b[d].repeats.values.push(5);break;case"FRI":case"6":b[d].repeats.alias+="周五 ",b[d].repeats.values.push(6);break;case"SAT":case"7":b[d].repeats.alias+="周六 ",b[d].repeats.values.push(7);break;case"SUN":case"1":b[d].repeats.alias+="周日 ",b[d].repeats.values.push(1)}b[d].repeats.alias=b[d].repeats.alias.replace(/(^\s*)|(\s*$)/g,"")}}else b[d].repeats.alias=f.years.toString()+"-"+f.months.toString()+"-"+f.daysOfMonth.toString(),b[d].repeats.values=[]}return b}function getLastTimer(){if($.isArray(timingData)&&timingData.length){var a="",b="";timingData.length>0&&timingData[0].enable===!0&&timingData[0].expired===!1&&(a=timingData[0].nextTriggerTime,b=timingData[0].code.raw),$timeLabel1.text(showTime(a,b))}else $timeLabel1.text("暂无执行任务")}function showTime(a,b){var c,d="暂无执行任务",e=(new Date).getTime(),f=new Date,g=f.getDay();nDate=new Date(Date.UTC(f.getFullYear(),f.getMonth(),f.getDate(),f.getHours(),f.getMinutes(),f.getSeconds()));nDate.getTime()/1e3-28800;if(g=0==g?7:g,0==a)d="暂无执行任务";else{var h=parseInt((a-e)/6e4),i=~~(h/60),j=h%60;b.indexOf(timerOn)>-1?c="开":b.indexOf(timerOff)>-1&&(c="关");var k=new Date(a),l=k.getDay();if(l=0==l?7:l,g>=l&&i>24)switch(l){case 1:d="下周一 "+c;break;case 2:d="下周二 "+c;break;case 3:d="下周三 "+c;break;case 4:d="下周四 "+c;break;case 5:d="下周五 "+c;break;case 6:d="下周六 "+c;break;case 7:d="下周日 "+c}else l>=g&&(d=""+i+"h"+j+"m后 "+c)}return d}function connect(a,b,c,d,e,f){$.ajax({type:a,headers:header,url:b,dataType:"json",data:c,cache:!1,success:function(a){$.isArray(a)?"list"==d?processing(a):"del"==d?(timingData.splice(f,1),e["delete"](f),getLastTimer()):"change"!=d&&"add"!=d||(getListTimer(),getLastTimer()):$.hekrToast("网络出误，请稍后重试！")},error:function(a,b,c){$timerID.is(":visible")&&("timeout"==b?$.hekrToast("响应超时，请稍后重试"):$.hekrToast("操作出现错误，请稍后重试"))}})}var workMode=0,appTid="APP_"+Math.random().toString(36).substr(2),devTid=window.devTid=getUrlParam("devTid"),ctrlKey=window.ctrlKey=getUrlParam("ctrlKey"),msgId=window.msgId=0,frameNum=0,heartbeat={msgId:msgId,action:"heartbeat"},appSendMsgTpl={msgId:msgId,action:"appSend",params:{devTid:devTid,ctrlKey:ctrlKey,appTid:appTid,data:{}}},protocolTemplete,deviceList=[],accessToken,header={};document.addEventListener("HekrSDKReady",function(){if(Hekr.currentUser(function(a){accessToken=a.access_token,$.ajax({type:"GET",url:"https://console-openapi.hekr.me/external/device/protocolTemplate",headers:{Authorization:"Bearer "+accessToken,Accept:"application/json","X-Hekr-ProdPubKey":getUrlParam("ppk")},success:function(a){protocolTemplete=a,sendCMD({},0)}}),header={Authorization:"Bearer "+accessToken,"Content-Type":"application/json",Accept:"application/json"},getListTimer();setInterval(function(){sendCMD({},0)},3e4)}),"undefined"!=typeof Hekr){var a={action:"devSend",params:{devTid:devTid}};Hekr.recv(a,function(a){setState(a.params.data.raw)})}else alert("注册监听炸了")},!1),$(".hekr-header-back").on("touchend",function(){window.close()});var evtArr=[function(){$(".page").hide(),$("#page1").show()},function(){$(".page").hide(),$("#page2").show(),getListTimer()}];$.hekrNav(evtArr),$("#slide-back").hekrSlide({delay:6e3});var instanceSlideBack=$("#slide-back").data("hekrSlide");$("#warn .hekr-slide").hekrSlide({delay:6e3});var instanceSlideWarn=$("#warn .hekr-slide").data("hekrSlide");$("#circle").hekrCircle({circles:[{color:"#13b5b1",beginAngle:Math.PI/2,min:0,max:100,width:10,gutter:0,value:0},{color:"#f29876",beginAngle:Math.PI/2,min:0,max:70,width:7,gutter:4,value:0}]});var instanceCircle=$("#circle").data("hekrCircle"),Circle=[0,0];$("#range1").hekrRangeSlider({type:"single",min:10,max:95,value:10,step:1,onChange:function(a){range(this,a)},updateContext:this});var instanceRangeSlider1=$("#range1").data("hekrRangeSlider");$("#gears").hekrSlotSelector({ratios:[1],radios:{number:2,name:"gears",ids:["g1","g2"],values:[1,2]},labels:["低风","高风"],slider:{init:!0,icon:'<i class="hekr-iconfont hekr-btn-on" style="font-size: .16rem;">&#xe852;</i> '},value:1,disabled:!1,onChange:gears});var instanceGears=$("#gears").data("hekrSlotSelector");$("#power").off("touchend").on("touchend",power),OFF();var html='<div class="hekr-slide-item"><i class="hekr-iconfont">&#xe853;</i><span>{text}</span></div>',timingData=[],$timerID=$("#page2"),$timeLabel1=$(".lasttimer .item-text"),timerOn="4807023d020191",timerOff="48070242020095";CronExpr={decode:function(a){var b={};return a=a.replace(/(^\s*)|(\s*$)/g,""),a=a.split(/\s/),b.seconds=a[0],b.minutes=a[1],b.hours=a[2],b.daysOfMonth=a[3],b.months=a[4],b.daysOfWeek=a[5],b.years="undefined"!=typeof a[6]?a[6]:null,b},encode:function(a){var b="";return a=a||{},"string"!=typeof a.seconds&&"number"!=typeof a.seconds?"":(b+=String(a.seconds)+" ","string"!=typeof a.minutes&&"number"!=typeof a.minutes?"":(b+=String(a.minutes)+" ","string"!=typeof a.hours&&"number"!=typeof a.hours?"":(b+=String(a.hours)+" ","string"!=typeof a.daysOfMonth&&"number"!=typeof a.daysOfMonth?"":(b+=String(a.daysOfMonth)+" ","string"!=typeof a.months&&"number"!=typeof a.months?"":(b+=String(a.months)+" ","string"!=typeof a.daysOfWeek&&"number"!=typeof a.daysOfWeek?"":(b+=String(a.daysOfWeek),"string"!=typeof a.years&&"number"!=typeof a.years||(b+=" "+String(a.years)),b))))))}};