/*! HekrSdk 2016-05-16 */
HI.SDK=function(data){if("undefined"!=typeof Hekr&&Hekr.ready)return Hekr;if(this!==HI.SDK||this instanceof HI.SDK)return HI.SDK.call(HI.SDK,data);var sdk=this.sdk,argLen=arguments.length;return 1===argLen&&_.isFunction(sdk.Init)?new sdk.Init(data):this},HI.SDK.sdk={},HI.SDK.initSdk=function(name,init,enforced){if(_.isString(name)&&name&&_.isFunction(init)){var sdk=HI.SDK.sdk;if(sdk)return sdk={Init:init},HI.SDK.sdk=sdk,init}return!1},function($,_,HI){var Sdk=function(config){var hekrConfig={host:"asia.app.hekr.me",port:86,ws:null,HekrRequest:{},url:"ws://asia.app.hekr.me:86",appTid:"APP_"+Math.random().toString(36).substr(2),heartBeatInterval:null,receiveCall:null,reConnectI:null,logInfo:{},msgId:0};if(!(this instanceof Sdk))return new Sdk(config);config=config||{};var defaults={uid:"",accessToken:""};return this.config=_.extend({},defaults,config),hekrConfig.logInfo={msgId:hekrConfig.msgId,action:"appLogin",params:{appTid:hekrConfig.appTid,token:this.config.accessToken}},hekrConfig.ws=new WebSocket(hekrConfig.url),this.hekrConfig=hekrConfig,this.ready=!1,this._bind(),this};Sdk.prototype.currentUser=function(callBack){return callBack(this.config)},Sdk.prototype.recv=function(filter,callback){var hekrConfig=this.hekrConfig;hekrConfig.receiveCall=callback},Sdk.prototype.send=function(command,devTid,callBack){var hekrConfig=this.hekrConfig,cmd=eval(command);cmd.params.appTid=hekrConfig.appTid,hekrConfig.HekrRequest[cmd.msgId]=callBack,this._sendMessage2Top("appSend",cmd),hekrConfig.ws.send(JSON.stringify(cmd))},Sdk.prototype._sendMessage2Top=function(action,message){message={action:action,message:message},window.top.postMessage(message,"*")},Sdk.prototype._getMsgId=function(){var hekrConfig=this.hekrConfig;return 65535===hekrConfig.msgId?hekrConfig.msgId=0:hekrConfig.msgId++,hekrConfig.msgId},Sdk.prototype._getHeartBeat=function(){return{msgId:this._getMsgId(),action:"heartbeat"}},Sdk.prototype._reConnect=function(){var hekrConfig=this.hekrConfig;hekrConfig.ws=new WebSocket(hekrConfig.url),this._bind()},Sdk.prototype._startReConnect=function(){var hekrConfig=this.hekrConfig;hekrConfig.reConnectI=setInterval($.proxy(this._reConnect,this),1e4)},Sdk.prototype._heartBeat=function(){var hekrConfig=this.hekrConfig,heartInfo=this._getHeartBeat();this._sendMessage2Top("heartbeat",JSON.stringify(heartInfo)),hekrConfig.ws.send(JSON.stringify(heartInfo)),console.log("send:"+JSON.stringify(heartInfo))},Sdk.prototype._startHeartBeat=function(){var hekrConfig=this.hekrConfig;hekrConfig.heartBeatInterval=setInterval($.proxy(this._heartBeat,this),2e4)},Sdk.prototype._bind=function(){var hekrConfig=this.hekrConfig,config=this.config,ws=hekrConfig.ws;ws.onmessage=$.proxy(function(e){var msg=eval("("+e.data+")");switch(msg.action){case"appSendResp":var callback=hekrConfig.HekrRequest[msg.msgId];this._sendMessage2Top("appSendResp",msg),callback.call(this,msg);break;case"appLoginResp":200==msg.code?this._startHeartBeat():hekrConfig.receiveCall.call(this,"app登录失败！error:"+JSON.stringify(msg));break;case"heartbeatResp":this._sendMessage2Top("appRecv",JSON.stringify(msg));break;case"devSend":hekrConfig.receiveCall.call(this,msg);break;case"errorResp":hekrConfig.receiveCall.call(this,msg);break;default:hekrConfig.receiveCall.call(this,msg)}},this),ws.onopen=$.proxy(function(){clearInterval(hekrConfig.reConnectI),ws.send(JSON.stringify(hekrConfig.logInfo))},this),ws.onclose=$.proxy(function(){clearInterval(hekrConfig.heartBeatInterval),this._startReConnect()},this),ws.onerror=$.proxy(function(){ws.close()},this),this.ready=!0},HI.SDK.initSdk("sdk",Sdk)}($,_,HI);
/*! HekrSdk 最后修改于： 2016-05-16 */